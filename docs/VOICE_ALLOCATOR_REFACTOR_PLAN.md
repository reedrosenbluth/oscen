# Voice Allocator Refactor & Static Graph Event Support

## Goal
Refactor `VoiceAllocator` to support static (compile-time) graphs using the standard `derive(Node)` macro, and update the macro to correctly handle event emission in static graphs using `StaticContext`.

## User Review Required
> [!IMPORTANT]
> This plan involves modifying the `derive(Node)` macro and the `graph!` macro codegen to support `StaticContext`. This is a core change to the static graph event system.

> [!WARNING]
> `VoiceAllocator`'s `ArrayEventOutput` implementation might conflict with `StaticContext` event emission if both are active. We will prioritize `StaticContext` for general event emission but ensure `ArrayEventOutput` routing (which is optimized for arrays) still works or is replaced by generic routing.

## Proposed Changes

### 1. `oscen-macros` (Macro Updates)

#### [MODIFY] [lib.rs](file:///Users/reedrosenbluth/Developer/oscen/oscen-macros/src/lib.rs)
- Update `derive_node` to generate `handle_events` that uses `StaticContext` instead of a dummy `ProcessingContext`.
- Add support for `on_{event}_static` handlers or generic handlers.

#### [MODIFY] [codegen.rs](file:///Users/reedrosenbluth/Developer/oscen/oscen-macros/src/graph_macro/codegen.rs)
- Update `generate_static_process` to:
    1. Create a shared `pending_events` buffer (ArrayVec).
    2. Pass this buffer to `StaticContext` when calling `handle_events`.
    3. After each node processes, route events from `pending_events` to their destinations.
    4. Clear `pending_events` for the next node.

### 2. `oscen-lib` (VoiceAllocator Refactor)

#### [MODIFY] [voice_allocator.rs](file:///Users/reedrosenbluth/Developer/oscen/oscen-lib/src/voice_allocator.rs)
- **Storage**: Remove per-node `StaticEventQueue` fields (`note_on`, `note_off`). Rely entirely on graph-owned storage generated by the macro.
- **Constructor**: Change to `pub fn new(sample_rate: f32) -> Self`.
- **Handlers**: Update `on_note_on` and `on_note_off` to use the new `EventContext` trait.
    ```rust
    fn on_note_on(&mut self, event: &EventInstance, ctx: &mut impl EventContext) {
        // Use ctx.emit_event_to_array(...) for voice allocation
    }
    ```
- **Routing Conflict**: Ensure `route_event` (used by runtime graphs) doesn't conflict with explicit handler emission. For static graphs, we will prefer handler-driven emission via `ctx.emit_event_to_array`.

### 3. `oscen-lib` (Traits & Contexts)

#### [MODIFY] [traits.rs](file:///Users/reedrosenbluth/Developer/oscen/oscen-lib/src/graph/traits.rs)
- Define `EventContext` trait:
    ```rust
    pub trait EventContext {
        fn emit_event(&mut self, output_index: usize, event: EventInstance);
        fn emit_timed_event(&mut self, output_index: usize, frame_offset: u32, payload: EventPayload);
        fn emit_scalar_event(&mut self, output_index: usize, frame_offset: u32, payload: f32);
        // Add support for array emission
        fn emit_event_to_array(&mut self, output_index: usize, array_index: usize, event: EventInstance);
    }
    ```
- Implement `EventContext` for `ProcessingContext`.

#### [MODIFY] [static_context.rs](file:///Users/reedrosenbluth/Developer/oscen/oscen-lib/src/graph/static_context.rs)
- Implement `EventContext` for `StaticContext`.
- Add `emit_event_to_array` support (handling the routing logic internally or via a special event type).

### 4. `oscen-macros` (Codegen Logic)

#### [MODIFY] [codegen.rs](file:///Users/reedrosenbluth/Developer/oscen/oscen-macros/src/graph_macro/codegen.rs)
- **Storage**: Confirm generation of graph-owned `{node}_{endpoint}_events` fields.
- **Process Loop**:
    1. **Route Inputs**: Copy events from graph inputs/upstream outputs into `{node}_{endpoint}_events`.
    2. **Process Node**:
        - Create `StaticContext` with shared `pending_events` buffer.
        - Call `node.handle_events(&mut ctx)`.
        - Call `node.process()`.
    3. **Route Outputs**: Drain `pending_events` to downstream node inputs (or graph outputs).
    4. **Clear**: Clear `{node}_{endpoint}_events` for the current node.

## Design Decisions:
- **Priority**: Performance-first with zero overhead
- **Context Approach**: Lightweight `StaticContext` for event emission
- **Compatibility**: Accept breaking changes (nodes must be adapted)
- **Storage**: `ArrayVec` for fixed-capacity stack-allocated queues

## Design Rationale: Comparison with CMajor
This plan is **architecturally aligned** with CMajor's static event routing but adapts the implementation for Rust's safety guarantees.

| Feature | CMajor (C++) | Oscen (Rust) | Rationale |
| :--- | :--- | :--- | :--- |
| **Topology** | Resolved at compile-time | Resolved at compile-time | Zero runtime overhead for connection logic. |
| **Storage** | Graph-owned (`_state` struct) | Graph-owned (`Graph` struct) | Centralized state management. |
| **Dispatch** | **Direct Call** (`_forwardEvent` calls handler) | **Buffered** (`emit` -> `pending` -> `drain`) | **Rust Ownership**: A node cannot directly call another node's handler because it would require simultaneous mutable borrows of both nodes. Buffering decouples the execution. |
| **Routing** | Runtime Indexing (`voiceEventOut[i]`) | Runtime Indexing (`emit_event_to_array(i, ...)`) | Efficient multiplexing without dynamic dispatch. |

**Conclusion**: We achieve the same goals (static topology, runtime indexing, no virtual calls) but use a "Store-and-Forward" pattern to satisfy the borrow checker.

## Phase 1: Core Infrastructure (Foundation) âœ… COMPLETE
## API Compatibility & Migration
- **Runtime Graphs**: Will continue to work. `ProcessingContext` implements `EventContext`, so generic handlers work automatically.
- **Static Graphs**: Will now support event emission via the same generic handlers.
- **User Code**: Users only need to change their handler signature from `ctx: &mut ProcessingContext` to `ctx: &mut impl EventContext` to support both graph types. This achieves the goal of a single, consistent outward-facing API.

## Verification Plan

### Automated Tests
- Create a new test file `examples/src/bin/static_voice_allocator_test.rs` that:
    - Instantiates a static graph with `VoiceAllocator`.
    - Feeds MIDI events.
    - Verifies that `voices` output receives the routed events.
- Run `cargo run --bin static_voice_allocator_test`.

### Manual Verification
- Verify `electric-piano` example (if applicable) or `simple_synth` with the new allocator.
